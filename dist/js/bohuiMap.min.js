var bhLib=window.bhLib=bhLib||{};!function(){var o=bhLib.dom=bhLib.dom||{},e=bhLib.map=bhLib.map||{},n=!1,a={},r=new p,t=document.getElementsByTagName("script"),i=t[t.length-1].getAttribute("src"),l=i.substr(0,i.lastIndexOf("/")+1),s=function(e,t){return void 0===e?t:e};function p(){this._eventMap={}}function c(){this.container=null,this.isOnline=!0,this.centerPoint=null,this.zoomLevel=1,this.maxZoom=19,this.minZoom=1,this.enableScrollWheelZoom=null,this.enableKeyboard=null,this.markerMap={},this.markerClusterOptions=null,this._bmap=null,this._defaultCursor=null,this._drawingManagerObject=null,this._polylineOptions={strokeColor:"#333",strokeWeight:"8",strokeOpacity:.8},this._filterCircle={circle:null,label:null},this._markerCluster=null}function h(e,t){var i;if(i=t,r.on("mapMainScriptLoaded",function(){for(var e=0,t=i.length;e<t;e++){var n=i[e];a[n]=!1,function(e){o.loadScript(e,function(){a[e]=!0})}(n)}}),e.isOnline)window.BMap_loadScriptTime=(new Date).getTime(),o.loadScript("http://api.map.baidu.com/getscript?v=2.0&ak="+e.ak,function(){n=!0,r.emit("mapMainScriptLoaded")});else{if(void 0===e.sourceRoot)throw new Error("离线地图需要传入sourceRoot");window.mapSourceRoot=e.sourceRoot,o.loadScript(e.sourceRoot+"/map_load.js",function(){n=!0,r.emit("mapMainScriptLoaded")})}}o.loadScript=function(e,t){var n=document.createElement("script");n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,t())}:n.onload=function(){t()},n.src=e,document.getElementsByTagName("head")[0].appendChild(n)},p.prototype.on=function(e,t){this._eventMap[e]||(this._eventMap[e]=[]),this._eventMap[e].push(t)},p.prototype.emit=function(e){try{for(var t,n=0;t=this._eventMap[e][n];n++)t()}catch(e){throw e}},c.prototype._onScriptReady=function(e){try{r.on("onScriptReady",e)}catch(e){throw e}},c.prototype.onReady=function(e){r.on("onReady",e.bind(this))},c.prototype._init=function(){var e=this.container,t=this.centerPoint,n=this.zoomLevel;if(this._bmap=new BMap.Map(e),this._bmap.setMaxZoom(this.maxZoom),this._bmap.setMinZoom(this.minZoom),this.enableScrollWheelZoom=this._bmap.enableScrollWheelZoom.bind(this._bmap),this.enableKeyboard=this._bmap.enableKeyboard.bind(this._bmap),this._defaultCursor=this._bmap.getDefaultCursor(),this._bmap.centerAndZoom(new BMap.Point(t[0],t[1]),n),this.markerClusterOptions&&this.markerClusterOptions.enable)try{this._enableMarkerCluster(this.markerClusterOptions.options)}catch(e){throw e}this._drawManagerInit(),r.emit("onReady")},c.prototype._toolsInit=function(){var e=document.createElement("div");e.className="bhMap-tools",e.id="bhMapTools",e.oncontextmenu=function(e){e.stopPropagation(),e.preventDefault()};var t=document.getElementById(this.container),n=document.createElement("link"),i=document.createElement("link");n.rel="stylesheet",n.href=l+"../css/bohuiMap.css",i.rel="stylesheet",i.href=l+"../font/iconfont.css",document.head.appendChild(n),document.head.appendChild(i),e.innerHTML='<span id="bhMapToolsMove" class="move">        <i class="iconfont bhMap-icon-shouzhi"></i>移动      </span>      <span id="bhMapToolsRanging" class="ranging">        <i class="iconfont bhMap-icon-ceju"></i>测距      </span>      <span id="bhMapToolsMark" class="mark">        <i class="iconfont bhMap-icon-weizhibiaoji"></i>标记      </span>      <span id="bhMapToolsArea" class="area">        <i class="iconfont bhMap-icon-zerenfanwei"></i>范围      </span>      <span id="bhMapToolsPolyline" class="way">        <i class="iconfont bhMap-icon-icon-xian"></i>路线      </span>',t.appendChild(e),this._toolsEventInit()},c.prototype.enableMapTools=function(e,t){var n=document.getElementById("bhMapTools");e?n?n.style.display="block":this._toolsInit():n&&(n.style.display="none"),t&&this.setMapTools(t)},c.prototype.setMapTools=function(e){if(!e)throw new Error("工具条的设置参数错误");try{this._polylineOptions.strokeWeight=s(e.polylineOptions.strokeWeight,this._polylineOptions.strokeWeight),this._polylineOptions.strokeColor=s(e.polylineOptions.strokeColor,this._polylineOptions.strokeColor),this._polylineOptions.strokeOpacity=s(e.polylineOptions.strokeOpacity,this._polylineOptions.strokeOpacity)}catch(e){throw new Error("工具条的设置参数错误")}},c.prototype._toolsEventInit=function(){var e=this,t=document.getElementById("bhMapToolsPolyline"),n=document.getElementById("bhMapToolsArea"),i=document.getElementById("bhMapToolsRanging"),o=document.getElementById("bhMapToolsMark"),a=document.getElementById("bhMapToolsMove");t.addEventListener("click",function(){e.enableDrawPolyLine()}),n.addEventListener("click",function(){e.enableCircleFilter()}),i.addEventListener("click",function(){e.enableRanging()}),o.addEventListener("click",function(){e.enableMark()}),a.addEventListener("click",function(){e._drawingManagerObject.close()})},c.prototype._drawManagerInit=function(){var a=this;this._drawingManagerObject=new BMapLib.DrawingManager(this._bmap,{isOpen:!1,drawingType:BMAP_DRAWING_CIRCLE,enableDrawingTool:!1,enableCalculate:!1,circleOptions:{fillColor:"blue",strokeWeight:1,fillOpacity:.3,strokeOpacity:1},polylineOptions:this._polylineOptions}),this._drawingManagerObject.addEventListener("polylinecomplete",function(e){a._drawingManagerObject.close();var t=e.getPath(),n=[];a._bmap.removeOverlay(e),t.forEach(function(e){n.push(new BMap.Point(e.lng,e.lat))});var i=new BMap.Polyline(n,a._polylineOptions);a._bmap.addOverlay(i);var o=new BMap.ContextMenu;o.addItem(new BMap.MenuItem("删除",function(e,t,n){a._bmap.removeOverlay(n)}.bind(i))),i.addContextMenu(o)})},c.prototype.enableDrawPolyLine=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_POLYLINE)},c.prototype.enableCircleFilter=function(){var c=this;this._bmap.enableDragging(),this._bmap.enableScrollWheelZoom(),this._drawingManagerObject.close(),this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_CIRCLE),this._bmap.removeOverlay(this._filterCircle.label),this._bmap.removeOverlay(this._filterCircle.circle),this._bmap.getOverlays().map(function(e){e.show()});var h=new BMap.Label;h.setOffset(new BMap.Size(10,-6)),BMapLib.EventWrapper.addListenerOnce(this._drawingManagerObject,"circlecomplete",function(e,t){var i=(c._filterCircle.circle=t).getRadius(),n=i.toFixed(2),o=t.getCenter();c._bmap.getOverlays().map(function(e){var t=e.point;e instanceof BMapLib.TextIconOverlay&&(t=e._position);var n=c._bmap.getDistance(t,o);i<n?e.hide():e.show()});var a=t.getBounds().getNorthEast(),r=new BMap.Point(a.lng,o.lat);h.setContent(n+"m"),h.setPosition(r),c._filterCircle.label=h,c._bmap.addOverlay(h),t.enableEditing(),t.addEventListener("lineupdate",c._reFilter.bind(c));var l=BMapLib.EventWrapper.addListener(c._bmap,"moveend",c._reFilter.bind(c)),s=BMapLib.EventWrapper.addListener(c._bmap,"zoomend",c._reFilter.bind(c));t.addEventListener("remove",function(){c._filterCircle.circle=null,c._filterCircle.label=null,c._bmap.getOverlays().map(function(e){e.show()}),BMapLib.EventWrapper.removeListener(l),BMapLib.EventWrapper.removeListener(s)});var p=new BMap.ContextMenu;p.addItem(new BMap.MenuItem("删除",function(e,t,n){n.disableEditing(),c._bmap.removeOverlay(n),c._bmap.removeOverlay(h)}.bind(t))),t.addContextMenu(p),c._drawingManagerObject.close(),c._bmap.panTo(o)})},c.prototype._reFilter=function(){var i=this;try{var e=this._filterCircle.circle,o=e.getRadius(),t=o.toFixed(2),a=e.getCenter(),n=e.getBounds().getNorthEast(),r=new BMap.Point(n.lng,a.lat),l=this._filterCircle.label;l.setContent(t+"m"),l.setPosition(r),this._bmap.getOverlays().map(function(e){var t=e.point;e instanceof BMapLib.TextIconOverlay&&(t=e._position);var n=i._bmap.getDistance(t,a);o<n?e.hide():e.show()}),l.show()}catch(e){}},c.prototype.enableRanging=function(){this._drawingManagerObject.close(),new BMapLib.DistanceTool(this._bmap).open()},c.prototype.enableMark=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_MARKER)},c.prototype.createMarker=function(e){if(!e||void 0===e.id||null===e.id)throw new Error("创建标记的参数不正确");var t=!!e.label,n=new BMap.Point(e.lng,e.lat),i=null;if(t)var o=new BMap.Label(e.label.content,{position:n});if(e.icon){var a=s(e.icon.width,19),r=s(e.icon.height,25),l=new BMap.Icon(e.icon.url,new BMap.Size(a,r));i=new BMap.Marker(n,{icon:l}),t&&o.setOffset(new BMap.Size(0,r))}else i=new BMap.Marker(n),t&&o.setOffset(new BMap.Size(0,25));return t&&e.label.style&&o.setStyle(e.label.style),t&&i.setLabel(o),this.markerMap[e.id]=i,this._markerCluster?this._markerCluster.addMarker(i):this._bmap.addOverlay(i),i},c.prototype.createPolyline=function(e){var t,n,i,o=[];try{t=s(e.options.strokeColor,"#333"),n=s(e.options.strokeWeight,"8"),i=s(e.options.strokeOpacity,.8)}catch(e){t="#333",n="8",i=.8}e.list.forEach(function(e){o.push(new BMap.Point(e.lng,e.lat))});var a=new BMap.Polyline(o,{enableEditing:!1,enableClicking:!0,strokeWeight:n,strokeOpacity:i,strokeColor:t});return this._bmap.addOverlay(a),a},c.prototype._enableMarkerCluster=function(e){if(!e&&(e={}),!BMapLib||!BMapLib.MarkerClusterer)throw new Error("缺少MarkerClusterer的js文件");if(!BMapLib||!BMapLib.TextIconOverlay)throw new Error("缺少TextIconOverlay的js文件");this._markerCluster=new BMapLib.MarkerClusterer(this._bmap,e)},c.prototype._render=function(e){if(null==e&&(e={}),t=e,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("reader函数的参数必须是个对象");var t;this.container=e.container,this.centerPoint=s(e.centerPoint,[116.404,39.915]),this.zoomLevel=s(e.zoomLevel,11),this.maxZoom=s(e.maxZoom,19),this.minZoom=s(e.minZoom,11),this.markerClusterOptions=s(e.markerClusterSetting,null),this._onScriptReady(this._init.bind(this)),function e(){!function(){var e=!0;for(var t in a)a.hasOwnProperty(t)&&(a[t]||(e=!1));return n&&e}()?setTimeout(e,300):r.emit("onScriptReady")}()},e.loadScript=h,e.render=function(e){var t=new c;try{t._render(e)}catch(e){throw e}return t}}();