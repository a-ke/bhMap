var bhLib=window.bhLib=bhLib||{};!function(){var i=bhLib.dom=bhLib.dom||{},e=bhLib.map=bhLib.map||{},n=!1,a={},r=new t,s=function(e,t){return void 0===e?t:e};function t(){this._eventMap={}}function o(){this.container=null,this.isOnline=!0,this.centerPoint=null,this.zoomLevel=1,this.maxZoom=19,this.minZoom=1,this.enableScrollWheelZoom=null,this.enableKeyboard=null,this.markerMap={},this._bmap=null,this._defaultCursor=null,this._drawingManagerObject=null,this._polylineOptions={strokeColor:"#333",strokeWeight:"8",strokeOpacity:.8},this._filterCircle={circle:null,label:null}}function l(e,t){var o;if(o=t,r.on("mapMainScriptLoaded",function(){for(var e=0,t=o.length;e<t;e++){var n=o[e];a[n]=!1,function(e){i.loadScript(e,function(){a[e]=!0})}(n)}}),e.isOnline)window.BMap_loadScriptTime=(new Date).getTime(),i.loadScript("http://api.map.baidu.com/getscript?v=2.0&ak="+e.ak,function(){n=!0,r.emit("mapMainScriptLoaded")});else{if(void 0===e.sourceRoot)throw new Error("离线地图需要传入sourceRoot");window.mapSourceRoot=e.sourceRoot,i.loadScript(e.sourceRoot+"/map_load.js",function(){n=!0,r.emit("mapMainScriptLoaded")})}}i.loadScript=function(e,t){var n=document.createElement("script");n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,t())}:n.onload=function(){t()},n.src=e,document.getElementsByTagName("head")[0].appendChild(n)},t.prototype.on=function(e,t){this._eventMap[e]||(this._eventMap[e]=[]),this._eventMap[e].push(t)},t.prototype.emit=function(e){try{for(var t,n=0;t=this._eventMap[e][n];n++)t()}catch(e){}},o.prototype._onScriptReady=function(e){r.on("onScriptReady",e)},o.prototype.onReady=function(e){r.on("onReady",e.bind(this))},o.prototype._init=function(){var e=this.container,t=this.centerPoint,n=this.zoomLevel;this._bmap=new BMap.Map(e),this._bmap.setMaxZoom(this.maxZoom),this._bmap.setMinZoom(this.minZoom),this.enableScrollWheelZoom=this._bmap.enableScrollWheelZoom.bind(this._bmap),this.enableKeyboard=this._bmap.enableKeyboard.bind(this._bmap),this._defaultCursor=this._bmap.getDefaultCursor(),this._bmap.centerAndZoom(new BMap.Point(t[0],t[1]),n),this._drawManagerInit(),r.emit("onReady")},o.prototype._toolsInit=function(){var e=document.createElement("div");e.className="bhMap-tools",e.id="bhMapTools",e.oncontextmenu=function(e){e.stopPropagation(),e.preventDefault()};var t=document.getElementById(this.container),n=document.createElement("link"),o=document.createElement("link");n.rel="stylesheet",n.href="./css/bohuiMap.css",o.rel="stylesheet",o.href="./font/iconfont.css",document.head.appendChild(n),document.head.appendChild(o),e.innerHTML='<span id="bhMapToolsMove" class="move">        <i class="iconfont bhMap-icon-shouzhi"></i>移动      </span>      <span id="bhMapToolsRanging" class="ranging">        <i class="iconfont bhMap-icon-ceju"></i>测距      </span>      <span id="bhMapToolsMark" class="mark">        <i class="iconfont bhMap-icon-weizhibiaoji"></i>标记      </span>      <span id="bhMapToolsArea" class="area">        <i class="iconfont bhMap-icon-zerenfanwei"></i>范围      </span>      <span id="bhMapToolsPolyline" class="way">        <i class="iconfont bhMap-icon-icon-xian"></i>路线      </span>',t.appendChild(e),this._toolsEventInit()},o.prototype.enableMapTools=function(e,t){var n=document.getElementById("bhMapTools");e?n?n.style.display="block":this._toolsInit():n&&(n.style.display="none"),t&&this.setMapTools(t)},o.prototype.setMapTools=function(e){if(!e)throw new Error("工具条的设置参数错误");try{this._polylineOptions.strokeWeight=s(e.polylineOptions.strokeWeight,this._polylineOptions.strokeWeight),this._polylineOptions.strokeColor=s(e.polylineOptions.strokeColor,this._polylineOptions.strokeColor),this._polylineOptions.strokeOpacity=s(e.polylineOptions.strokeOpacity,this._polylineOptions.strokeOpacity)}catch(e){throw new Error("工具条的设置参数错误")}},o.prototype._toolsEventInit=function(){var e=this,t=document.getElementById("bhMapToolsPolyline"),n=document.getElementById("bhMapToolsArea"),o=document.getElementById("bhMapToolsRanging"),i=document.getElementById("bhMapToolsMark"),a=document.getElementById("bhMapToolsMove");t.addEventListener("click",function(){e.enableDrawPolyLine()}),n.addEventListener("click",function(){e.enableCircleFilter()}),o.addEventListener("click",function(){e.enableRanging()}),i.addEventListener("click",function(){e.enableMark()}),a.addEventListener("click",function(){e._drawingManagerObject.close()})},o.prototype._drawManagerInit=function(){var a=this;this._drawingManagerObject=new BMapLib.DrawingManager(this._bmap,{isOpen:!1,drawingType:BMAP_DRAWING_CIRCLE,enableDrawingTool:!1,enableCalculate:!1,circleOptions:{fillColor:"blue",strokeWeight:1,fillOpacity:.3,strokeOpacity:1},polylineOptions:this._polylineOptions}),this._drawingManagerObject.addEventListener("polylinecomplete",function(e){a._drawingManagerObject.close();var t=e.getPath(),n=[];a._bmap.removeOverlay(e),t.forEach(function(e){n.push(new BMap.Point(e.lng,e.lat))});var o=new BMap.Polyline(n,a._polylineOptions);a._bmap.addOverlay(o);var i=new BMap.ContextMenu;i.addItem(new BMap.MenuItem("删除",function(e,t,n){a._bmap.removeOverlay(n)}.bind(o))),o.addContextMenu(i)})},o.prototype.enableDrawPolyLine=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_POLYLINE)},o.prototype.enableCircleFilter=function(){var p=this;this._bmap.enableDragging(),this._bmap.enableScrollWheelZoom(),this._drawingManagerObject.close(),this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_CIRCLE),this._bmap.removeOverlay(this._filterCircle.label),this._bmap.removeOverlay(this._filterCircle.circle),this._bmap.getOverlays().map(function(e){e.show()});var c=new BMap.Label;c.setOffset(new BMap.Size(10,-6)),BMapLib.EventWrapper.addListenerOnce(this._drawingManagerObject,"circlecomplete",function(e,t){var n=(p._filterCircle.circle=t).getRadius(),o=n.toFixed(2),i=t.getCenter(),a=p._bmap.getOverlays();a.map(function(e){var t=p._bmap.getDistance(e.point,i);n<t?e.hide():e.show()});var r=t.getBounds().getNorthEast(),l=new BMap.Point(r.lng,i.lat);c.setContent(o+"m"),c.setPosition(l),p._filterCircle.label=c,p._bmap.addOverlay(c),t.enableEditing(),t.addEventListener("lineupdate",function(e){n=t.getRadius(),o=n.toFixed(2),i=t.getCenter(),r=t.getBounds().getNorthEast(),l=new BMap.Point(r.lng,i.lat),c.setContent(o+"m"),c.setPosition(l),p._bmap.getOverlays().map(function(e){var t=p._bmap.getDistance(e.point,i);n<t?e.hide():e.show()})});var s=new BMap.ContextMenu;s.addItem(new BMap.MenuItem("删除",function(e,t,n){n.disableEditing(),p._bmap.removeOverlay(n),p._bmap.removeOverlay(c),a.map(function(e){e.show()})}.bind(t))),t.addContextMenu(s),p._drawingManagerObject.close(),p._bmap.panTo(i)})},o.prototype.enableRanging=function(){this._drawingManagerObject.close(),new BMapLib.DistanceTool(this._bmap).open()},o.prototype.enableMark=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_MARKER)},o.prototype.createMarker=function(e){if(!e||!e.id)throw new Error("创建标记的参数不正确");var t=!!e.label,n=new BMap.Point(e.lng,e.lat),o=null;if(t)var i=new BMap.Label(e.label.content,{position:n});if(e.icon){var a=s(e.icon.width,19),r=s(e.icon.height,25),l=new BMap.Icon(e.icon.url,new BMap.Size(a,r));o=new BMap.Marker(n,{icon:l}),t&&i.setOffset(new BMap.Size(0,r))}else o=new BMap.Marker(n),t&&i.setOffset(new BMap.Size(0,25));return t&&e.label.style&&i.setStyle(e.label.style),t&&o.setLabel(i),this.markerMap[e.id]=o,this._bmap.addOverlay(o),o},o.prototype.createPolyline=function(e){var t,n,o,i=[];try{t=s(e.options.strokeColor,"#333"),n=s(e.options.strokeWeight,"8"),o=s(e.options.strokeOpacity,.8)}catch(e){t="#333",n="8",o=.8}e.list.forEach(function(e){i.push(new BMap.Point(e.lng,e.lat))});var a=new BMap.Polyline(i,{enableEditing:!1,enableClicking:!0,strokeWeight:n,strokeOpacity:o,strokeColor:t});return this._bmap.addOverlay(a),a},o.prototype._render=function(e){if(null==e&&(e={}),t=e,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("options must be an object");var t;this.container=e.container,this.centerPoint=s(e.centerPoint,[116.404,39.915]),this.zoomLevel=s(e.zoomLevel,11),this.maxZoom=s(e.maxZoom,19),this.minZoom=s(e.minZoom,11),this._onScriptReady(this._init.bind(this)),function e(){!function(){var e=!0;for(var t in a)a.hasOwnProperty(t)&&(a[t]||(e=!1));return n&&e}()?setTimeout(e,300):r.emit("onScriptReady")}()},e.loadScript=l,e.render=function(e){var t=new o;return t._render(e),t}}();