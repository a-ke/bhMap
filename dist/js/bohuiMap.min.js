var bhLib=window.bhLib=bhLib||{};!function(){var r=bhLib.dom=bhLib.dom||{},e=bhLib.map=bhLib.map||{},n=!1,a={},l=new s,t=document.getElementsByTagName("script"),i=t[t.length-1].getAttribute("src"),o=i.substr(0,i.lastIndexOf("/")+1),p=function(e,t){return void 0===e?t:e};function s(){this._eventMap={}}function c(){var s=function(e){var t=a(e.getNorthEast().lng,-180,180),n=a(e.getSouthWest().lng,-180,180),i=a(e.getNorthEast().lat,-74,74),r=a(e.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(n,r),new BMap.Point(t,i))},a=function(e,t,n){return t&&(e=Math.max(e,t)),n&&(e=Math.min(e,n)),e};function e(e){this._markerClusterer=e,this._map=e.getMap(),this._minClusterSize=e.getMinClusterSize(),this._isAverageCenter=e.isAverageCenter(),this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1,this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles(),clusterImageIndex:this._getImageIndex()})}return e.prototype._getImageIndex=function(){for(var e,t=0,n=0;e=this._markers[n];n++)void 0===e.clusterImageIndex&&(e.clusterImageIndex=0),e.clusterImageIndex>t&&(t=e.clusterImageIndex);return t},e.prototype.addMarker=function(e){if(this.isMarkerInCluster(e))return!1;if(this._center){if(this._isAverageCenter){var t=this._markers.length+1,n=(this._center.lat*(t-1)+e.getPosition().lat)/t,i=(this._center.lng*(t-1)+e.getPosition().lng)/t;this._center=new BMap.Point(i,n),this.updateGridBounds()}}else this._center=e.getPosition(),this.updateGridBounds();e.isInCluster=!0,this._markers.push(e);var r=this._markers.length;if(r<this._minClusterSize)return this._map.addOverlay(e),!0;if(r===this._minClusterSize)for(var a=0;a<r;a++)this._markers[a].getMap()&&this._map.removeOverlay(this._markers[a]);return this._map.addOverlay(this._clusterMarker),this._isReal=!0,this.updateClusterMarker(),!0},e.prototype.isMarkerInCluster=function(e){if(this._markers.indexOf)return-1!=this._markers.indexOf(e);for(var t,n=0;t=this._markers[n];n++)if(t===e)return!0;return!1},e.prototype.isMarkerInClusterBounds=function(e){return this._gridBounds.containsPoint(e.getPosition())},e.prototype.isReal=function(e){return this._isReal},e.prototype.updateGridBounds=function(){var e=new BMap.Bounds(this._center,this._center);this._gridBounds=function(e,t,n){t=s(t);var i=e.pointToPixel(t.getNorthEast()),r=e.pointToPixel(t.getSouthWest());i.x+=n,i.y-=n,r.x-=n,r.y+=n;var a=e.pixelToPoint(i),o=e.pixelToPoint(r);return new BMap.Bounds(o,a)}(this._map,e,this._markerClusterer.getGridSize())},e.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);for(var e,t=0;e=this._markers[t];t++)this._map.addOverlay(e)}else this._markers.length<this._minClusterSize?this._clusterMarker.hide():(this._clusterMarker.setPosition(this._center),this._clusterMarker.setText(this._markers.length),this._clusterMarker.setImageIndex(this._getImageIndex()))},e.prototype.remove=function(){for(var e=0;this._markers[e];e++)this._markers[e].getMap()&&this._map.removeOverlay(this._markers[e]);this._map.removeOverlay(this._clusterMarker),this._markers.length=0,delete this._markers},e.prototype.getBounds=function(){for(var e,t=new BMap.Bounds(this._center,this._center),n=0;e=this._markers[n];n++)t.extend(e.getPosition());return t},e.prototype.getCenter=function(){return this._center},e}function h(){this.container=null,this.isOnline=!0,this.centerPoint=null,this.zoomLevel=1,this.maxZoom=19,this.minZoom=1,this.enableScrollWheelZoom=null,this.enableKeyboard=null,this.markerMap={},this.markerClusterOptions=null,this._bmap=null,this._defaultCursor=null,this._drawingManagerObject=null,this._polylineOptions={strokeColor:"#333",strokeWeight:"8",strokeOpacity:.8},this._filterCircle={circle:null,label:null},this._markerCluster=null,this._CumtomOverlay=null}function u(e,t){var i;if(i=t,l.on("mapMainScriptLoaded",function(){for(var e=0,t=i.length;e<t;e++){var n=i[e];a[n]=!1,function(e){r.loadScript(e,function(){a[e]=!0})}(n)}}),e.isOnline)window.BMap_loadScriptTime=(new Date).getTime(),r.loadScript("http://api.map.baidu.com/getscript?v=2.0&ak="+e.ak,function(){n=!0,l.emit("mapMainScriptLoaded")});else{if(void 0===e.sourceRoot)throw new Error("离线地图需要传入sourceRoot");window.mapSourceRoot=e.sourceRoot,r.loadScript(e.sourceRoot+"/map_load.js",function(){n=!0,l.emit("mapMainScriptLoaded")})}!function e(){d()?l.emit("onScriptReady"):setTimeout(e,300)}()}function d(){var e=!0;for(var t in a)a.hasOwnProperty(t)&&(a[t]||(e=!1));return n&&e}r.loadScript=function(e,t){var n=document.createElement("script");n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,t())}:n.onload=function(){t()},n.src=e,document.getElementsByTagName("head")[0].appendChild(n)},s.prototype.on=function(e,t){this._eventMap[e]||(this._eventMap[e]=[]),this._eventMap[e].push(t)},s.prototype.off=function(e,t){if(this._eventMap[e]){var n=this._eventMap[e].indexOf(t);this._eventMap[e].splice(n,1)}},s.prototype.clean=function(e){this._eventMap[e]&&delete this._eventMap[e]},s.prototype.emit=function(e){try{for(var t,n=Array.prototype.slice.call(arguments,1),i=0;t=this._eventMap[e][i];i++)t.apply(null,n)}catch(e){throw e}},h.prototype._onScriptReady=function(e){try{d()?e():l.on("onScriptReady",e)}catch(e){throw e}},h.prototype.onReady=function(e){l.on("ready",e.bind(this))},h.prototype._init=function(){var e=this.container,t=this.centerPoint,n=this.zoomLevel;this._bmap=new BMap.Map(e),this._bmap.setMaxZoom(this.maxZoom),this._bmap.setMinZoom(this.minZoom),this.enableScrollWheelZoom=this._bmap.enableScrollWheelZoom.bind(this._bmap),this.enableKeyboard=this._bmap.enableKeyboard.bind(this._bmap),this._defaultCursor=this._bmap.getDefaultCursor(),this._bmap.centerAndZoom(new BMap.Point(t[0],t[1]),n);var i=new BMap.NavigationControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,type:BMAP_NAVIGATION_CONTROL_SMALL});if(this._bmap.addControl(i),this._CumtomOverlay=function(){function e(e,t,n){this._map=e,this._point=new BMap.Point(t[0],t[1]),this._html=n}return(e.prototype=new BMap.Overlay).initialize=function(){var e=this._div=document.createElement("div");return e.style.position="absolute",e.style.zIndex=BMap.Overlay.getZIndex(this._point.lat),e.style.minWidth="20px",e.style.minHeight="20px",e.innerHTML=this._html,this._map.getPanes().floatPane.appendChild(e),this._map.addEventListener("zoomend",this.draw.bind(this)),e},e.prototype.draw=function(){var e=this._map.pointToOverlayPixel(this._point);this._div.style.left=e.x+10+"px",this._div.style.top=e.y-10+"px"},e.prototype.remove=function(){this._div.parentElement.removeChild(this._div)},e}(),this.markerClusterOptions&&this.markerClusterOptions.enable)try{this._enableMarkerCluster(this.markerClusterOptions.options)}catch(e){throw e}this._drawManagerInit(),l.emit("ready")},h.prototype._toolsInit=function(){var e=document.createElement("div");e.className="bhMap-tools",e.id="bhMapTools",e.oncontextmenu=function(e){e.stopPropagation(),e.preventDefault()};var t=document.getElementById(this.container),n=document.createElement("link"),i=document.createElement("link");n.rel="stylesheet",n.href=o+"../css/bohuiMap.css",i.rel="stylesheet",i.href=o+"../font/iconfont.css",document.head.appendChild(n),document.head.appendChild(i),e.innerHTML='<span id="bhMapToolsMove" class="move">        <i class="iconfont bhMap-icon-shouzhi"></i>移动      </span>      <span id="bhMapToolsRanging" class="ranging">        <i class="iconfont bhMap-icon-ceju"></i>测距      </span>      <span id="bhMapToolsMark" class="mark">        <i class="iconfont bhMap-icon-weizhibiaoji"></i>标记      </span>      <span id="bhMapToolsArea" class="area">        <i class="iconfont bhMap-icon-zerenfanwei"></i>范围      </span>      <span id="bhMapToolsPolyline" class="way">        <i class="iconfont bhMap-icon-icon-xian"></i>路线      </span>',t.appendChild(e),this._toolsEventInit()},h.prototype.enableMapTools=function(e,t){var n=document.getElementById("bhMapTools");e?n?n.style.display="block":this._toolsInit():n&&(n.style.display="none"),t&&this.setMapTools(t)},h.prototype.setMapTools=function(e){if(!e)throw new Error("工具条的设置参数错误");try{this._polylineOptions.strokeWeight=p(e.polylineOptions.strokeWeight,this._polylineOptions.strokeWeight),this._polylineOptions.strokeColor=p(e.polylineOptions.strokeColor,this._polylineOptions.strokeColor),this._polylineOptions.strokeOpacity=p(e.polylineOptions.strokeOpacity,this._polylineOptions.strokeOpacity)}catch(e){throw new Error("工具条的设置参数错误")}},h.prototype._toolsEventInit=function(){var e=this,t=document.getElementById("bhMapToolsPolyline"),n=document.getElementById("bhMapToolsArea"),i=document.getElementById("bhMapToolsRanging"),r=document.getElementById("bhMapToolsMark"),a=document.getElementById("bhMapToolsMove");t.addEventListener("click",function(){e.enableDrawPolyLine()}),n.addEventListener("click",function(){e.enableCircleFilter()}),i.addEventListener("click",function(){e.enableRanging()}),r.addEventListener("click",function(){e.enableMark()}),a.addEventListener("click",function(){e._drawingManagerObject.close()})},h.prototype._drawManagerInit=function(){var a=this;this._drawingManagerObject=new BMapLib.DrawingManager(this._bmap,{isOpen:!1,drawingType:BMAP_DRAWING_CIRCLE,enableDrawingTool:!1,enableCalculate:!1,circleOptions:{fillColor:"blue",strokeWeight:1,fillOpacity:.3,strokeOpacity:1},polylineOptions:this._polylineOptions}),this._drawingManagerObject.addEventListener("polylinecomplete",function(e){a._drawingManagerObject.close();var t=e.getPath(),n=[];a._bmap.removeOverlay(e),t.forEach(function(e){n.push(new BMap.Point(e.lng,e.lat))});var i=new BMap.Polyline(n,a._polylineOptions);a._bmap.addOverlay(i);var r=new BMap.ContextMenu;r.addItem(new BMap.MenuItem("删除",function(e,t,n){a._bmap.removeOverlay(n)}.bind(i))),i.addContextMenu(r)}),this._drawingManagerObject.addEventListener("markercomplete",function(e,t){l.emit("markercomplete",t)}),this._drawingManagerObject.addEventListener("polylinecomplete",function(e){l.emit("polylinecomplete",e)})},h.prototype.enableDrawPolyLine=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_POLYLINE)},h.prototype.enableCircleFilter=function(){var c=this;this._bmap.enableDragging(),this._bmap.enableScrollWheelZoom(),this._drawingManagerObject.close(),this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_CIRCLE),this._bmap.removeOverlay(this._filterCircle.label),this._bmap.removeOverlay(this._filterCircle.circle),this._bmap.getOverlays().map(function(e){e.show()});var h=new BMap.Label;h.setOffset(new BMap.Size(10,-6)),BMapLib.EventWrapper.addListenerOnce(this._drawingManagerObject,"circlecomplete",function(e,t){var i=(c._filterCircle.circle=t).getRadius(),n=i.toFixed(2),r=t.getCenter();c._bmap.getOverlays().map(function(e){var t=e.point;e instanceof BMapLib.TextIconOverlay&&(t=e._position);var n=c._bmap.getDistance(t,r);i<n?e.hide():e.show()});var a=t.getBounds().getNorthEast(),o=new BMap.Point(a.lng,r.lat);h.setContent(n+"m"),h.setPosition(o),c._filterCircle.label=h,c._bmap.addOverlay(h),t.enableEditing(),t.addEventListener("lineupdate",c._reFilter.bind(c));var s=BMapLib.EventWrapper.addListener(c._bmap,"moveend",c._reFilter.bind(c)),l=BMapLib.EventWrapper.addListener(c._bmap,"zoomend",c._reFilter.bind(c));t.addEventListener("remove",function(){c._filterCircle.circle=null,c._filterCircle.label=null,c._bmap.getOverlays().map(function(e){e.show()}),BMapLib.EventWrapper.removeListener(s),BMapLib.EventWrapper.removeListener(l)});var p=new BMap.ContextMenu;p.addItem(new BMap.MenuItem("删除",function(e,t,n){n.disableEditing(),c._bmap.removeOverlay(n),c._bmap.removeOverlay(h)}.bind(t))),t.addContextMenu(p),c._drawingManagerObject.close(),c._bmap.panTo(r)})},h.prototype._reFilter=function(){var i=this;try{var e=this._filterCircle.circle,r=e.getRadius(),t=r.toFixed(2),a=e.getCenter(),n=e.getBounds().getNorthEast(),o=new BMap.Point(n.lng,a.lat),s=this._filterCircle.label;s.setContent(t+"m"),s.setPosition(o),this._bmap.getOverlays().map(function(e){var t=e.point;e instanceof BMapLib.TextIconOverlay&&(t=e._position);var n=i._bmap.getDistance(t,a);r<n?e.hide():e.show()}),s.show()}catch(e){}},h.prototype.enableRanging=function(){this._drawingManagerObject.close(),new BMapLib.DistanceTool(this._bmap).open()},h.prototype.enableMark=function(){this._drawingManagerObject.open(),this._drawingManagerObject.setDrawingMode(BMAP_DRAWING_MARKER)},h.prototype.createMarker=function(e){if(!e||void 0===e.id||null===e.id)throw new Error("创建标记的参数不正确");var t=!!e.label,n=new BMap.Point(e.lng,e.lat),i=null;if(t)var r=new BMap.Label(e.label.content,{position:n});if(e.icon){var a=p(e.icon.width,19),o=p(e.icon.height,25),s=new BMap.Icon(e.icon.url,new BMap.Size(a,o));i=new BMap.Marker(n,{icon:s}),t&&r.setOffset(new BMap.Size(0,o))}else i=new BMap.Marker(n),t&&r.setOffset(new BMap.Size(0,25));return t&&e.label.style&&r.setStyle(e.label.style),t&&i.setLabel(r),this.markerMap[e.id]=i,this._markerCluster?this._markerCluster.addMarker(i):this._bmap.addOverlay(i),i},h.prototype.createPolyline=function(e){var t,n,i,r=[];try{t=p(e.options.strokeColor,"#333"),n=p(e.options.strokeWeight,"8"),i=p(e.options.strokeOpacity,.8)}catch(e){t="#333",n="8",i=.8}e.list.forEach(function(e){r.push(new BMap.Point(e.lng,e.lat))});var a=new BMap.Polyline(r,{enableEditing:!1,enableClicking:!0,strokeWeight:n,strokeOpacity:i,strokeColor:t});return this._bmap.addOverlay(a),a},h.prototype._enableMarkerCluster=function(e){if(!e&&(e={}),!BMapLib||!BMapLib.MarkerClusterer)throw new Error("缺少MarkerClusterer的js文件");if(!BMapLib||!BMapLib.TextIconOverlay)throw new Error("缺少TextIconOverlay的js文件");if(this.markerClusterOptions.clickExpand=p(this.markerClusterOptions.clickExpand,!0),!this.markerClusterOptions.clickExpand){this._rewriteTextIconOverlay();var t=c();this._rewriteMarkerClusterer(t)}this._markerCluster=new BMapLib.MarkerClusterer(this._bmap,e)},h.prototype._rewriteTextIconOverlay=function(){try{var e=BMapLib.TextIconOverlay;e.prototype.getStyleByText=function(e,t){return t[this._options.clusterImageIndex]},e.prototype.setImageIndex=function(e){this._options.clusterImageIndex=e,this._updateText(),this._updateCss(),this._updatePosition()}}catch(e){}},h.prototype._rewriteMarkerClusterer=function(s){try{var e=BMapLib.MarkerClusterer;e.prototype._addToClosestCluster=function(e){for(var t,n=4e6,i=null,r=0;t=this._clusters[r];r++){var a=t.getCenter();if(a){var o=this._map.getDistance(a,e.getPosition());o<n&&(n=o,i=t)}!function(t){t._clusterMarker.onclick=function(e){l.emit("clusterClick",t)}}(t)}i&&i.isMarkerInClusterBounds(e)?i.addMarker(e):((t=new s(this)).addMarker(e),this._clusters.push(t))},e.prototype._redraw=function(){this._clearLastClusters(),this._createClusters();for(var e,t=0;e=this._clusters[t];t++)!function(t){t._clusterMarker.onclick=function(e){l.emit("clusterClick",t)}}(e)}}catch(e){}},h.prototype.onClusterClick=function(e){l.on("clusterClick",e)},h.prototype.createCustomOverlay=function(e,t){var n=new this._CumtomOverlay(this._bmap,e,t);return this._bmap.addOverlay(n),n},h.prototype.addEventListener=function(e,t){l.on(e,t)},h.prototype.removeEventListener=function(e,t){l.off(e,t)},h.prototype._render=function(e){if(null==e&&(e={}),t=e,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("reader函数的参数必须是个对象");var t;this.container=e.container,this.centerPoint=p(e.centerPoint,[116.404,39.915]),this.zoomLevel=p(e.zoomLevel,11),this.maxZoom=p(e.maxZoom,19),this.minZoom=p(e.minZoom,11),this.markerClusterOptions=p(e.markerClusterSetting,null),this._onScriptReady(this._init.bind(this))},e.loadScript=u,e.render=function(e){var t=new h;try{t._render(e)}catch(e){throw e}return t},e.onAllScriptLoaded=function(e){l.on("onScriptReady",e)}}();